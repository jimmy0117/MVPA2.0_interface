<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新增病歷資料</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}">
</head>
<body>
    <h1>新增病歷資料</h1>

    <div class="card2">
        <div class="steps-indicator">
            <span class="step-dot" id="dot-1">1</span>
            <span class="step-dot" id="dot-2">2</span>
            <span class="step-dot" id="dot-3">3</span>
        </div>

        <form action="{{ url_for('save_medical') }}" method="post" id="medicalForm">
            <!-- 步驟 1：基本資料 + 症狀 -->
            <div class="step" id="step-1">

                <h2>基本資料</h2>
                <div class="form-group">
                  <label>性別:</label>
                  <select name="sex" required>
                      <option value="1">男</option>
                      <option value="2">女</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>年齡:</label>
                  <input type="number" name="age" min="0" required>
                </div>

                <h2>症狀</h2>
                <div class="form-group-pair">
                    <div class="form-group">
                        <label>音域變窄:</label>
                        <select name="narrow_pitch_range"><option value="0">無</option><option value="1">有</option></select>
                    </div>
                    <div class="form-group">
                        <label>說話音量變小:</label>
                        <select name="decreased_volume"><option value="0">無</option><option value="1">有</option></select>
                    </div>
                </div>
                <div class="form-group-pair">
                    <div class="form-group">
                        <label>說話久了容易累:</label>
                        <select name="fatigue"><option value="0">無</option><option value="1">有</option></select>
                    </div>
                    <div class="form-group">
                        <label>喉嚨常覺得乾:</label>
                        <select name="dryness"><option value="0">無</option><option value="1">有</option></select>
                    </div>
                </div>
                <div class="form-group-pair">
                    <div class="form-group">
                        <label>喉嚨有異物感:</label>
                        <select name="lumping"><option value="0">無</option><option value="1">有</option></select>
                    </div>
                    <div class="form-group">
                        <label>胸口有灼熱感:</label>
                        <select name="heartburn"><option value="0">無</option><option value="1">有</option></select>
                    </div>
                </div>
                <div class="form-group-pair">
                    <div class="form-group">
                        <label>吞東西容易嗆到:</label>
                        <select name="choking"><option value="0">無</option><option value="1">有</option></select>
                    </div>
                    <div class="form-group">
                        <label>眼睛乾澀:</label>
                        <select name="eye_dryness"><option value="0">無</option><option value="1">有</option></select>
                    </div>
                </div>
                <div class="form-group-pair">
                    <div class="form-group">
                        <label>鼻涕倒流:</label>
                        <select name="pnd"><option value="0">無</option><option value="1">有</option></select>
                    </div>
                    <div class="form-group">
                        <label>糖尿病:</label>
                        <select name="diabetes"><option value="0">無</option><option value="1">有</option></select>
                    </div>
                </div>
                <div class="form-group-pair">
                    <div class="form-group">
                        <label>高血壓:</label>
                        <select name="hypertension"><option value="0">無</option><option value="1">有</option></select>
                    </div>
                    <div class="form-group">
                        <label>心臟病:</label>
                        <select name="cad"><option value="0">無</option><option value="1">有</option></select>
                    </div>
                </div>
                <div class="form-group-pair">
                    <div class="form-group">
                        <label>頭頸部腫瘤:</label>
                        <select name="head_and_neck_cancer"><option value="0">無</option><option value="1">有</option></select>
                    </div>
                    <div class="form-group">
                        <label>頭部損傷:</label>
                        <select name="head_injury"><option value="0">無</option><option value="1">有</option></select>
                    </div>
                </div>
                <div class="form-group-pair">
                    <div class="form-group">
                        <label>腦中風:</label>
                        <select name="cva"><option value="0">無</option><option value="1">有</option></select>
                    </div>
                </div>

                <div class="nav-row">
                    <button type="button" class="nav-btn btn-next right" onclick="nextStep()">下一步</button>
                </div>
            </div>

            <!-- 步驟 2：生活習慣 + 發聲相關 -->
            <div class="step" id="step-2">
                <h2>生活習慣</h2>
                <div class="form-group-pair">
                    <div class="form-group">
                        <label>抽菸:</label>
                        <select name="smoking" id="smoking">
                            <option value="0">從未</option>
                            <option value="1">已戒菸</option>
                            <option value="2">有抽菸</option>
                            <option value="3">電子菸</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>一天幾包菸:</label>
                        <input type="number" name="ppd" id="ppd" min="0" step="1" required>
                    </div>
                </div>
                <div class="form-group-pair">
                    <div class="form-group">
                        <label>喝酒:</label>
                        <select name="drinking">
                            <option value="0">從未</option>
                            <option value="1">已戒酒</option>
                            <option value="2">有喝酒</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>喝酒頻率:</label>
                        <select name="frequency">
                            <option value="0">不喝</option>
                            <option value="1">偶爾喝</option>
                            <option value="2">每周喝</option>
                            <option value="3">幾乎每天</option>
                        </select>
                    </div>
                </div>

                <h2>發聲相關</h2>
                <div class="form-group-pair">
                    <div class="form-group">
                        <label>症狀如何發生:</label>
                        <select name="onset_of_dysphonia">
                            <option value="1">突然</option>
                            <option value="2">逐漸變差</option>
                            <option value="3">時好時壞</option>
                            <option value="4">從小開始</option>
                            <option value="5">其他</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>工作環境是否吵雜:</label>
                        <select name="noise_at_work">
                            <option value="1">否</option>
                            <option value="2">有一點</option>
                            <option value="3">很吵</option>
                        </select>
                    </div>
                </div>
                <div class="form-group-pair">
                    <div class="form-group">
                        <label>聲音何時最差:</label>
                        <select name="diurnal_pattern">
                            <option value="1">早上</option>
                            <option value="2">下午</option>
                            <option value="3">晚上</option>
                            <option value="4">都一樣</option>
                            <option value="5">不一定</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>用聲情形:</label>
                        <select name="occupational_vocal_demand">
                            <option value="1">總是需要</option>
                            <option value="2">經常需要</option>
                            <option value="3">偶而需要</option>
                            <option value="4">不需要</option>
                        </select>
                    </div>
                </div>

                <div class="nav-row">
                    <button type="button" class="nav-btn btn-prev" onclick="prevStep()">上一步</button>
                    <button type="button" class="nav-btn btn-next" onclick="nextStep()">下一步</button>
                </div>
            </div>

            <!-- 步驟 3：VHI-10 -->
            <div class="step" id="step-3">

                <h3>VHI-10 問題 (0=不嚴重 ~ 4=最嚴重)</h3>
                    <div class="form-group-pair">
                        <div class="form-group vhi-group">
                            <label>1. 說話時會上氣不接下氣:</label>
                            <select name="vhi1">{% for i in range(5) %}<option value="{{ i }}">{{ i }}</option>{% endfor %}</select>
                        </div>
                    </div>
                    <div class="form-group-pair">
                        <div class="form-group vhi-group">
                            <label>2. 我的嗓音一天內有不同的變化:</label>
                            <select name="vhi2">{% for i in range(5) %}<option value="{{ i }}">{{ i }}</option>{% endfor %}</select>
                        </div>
                    </div>
                    <div class="form-group-pair">
                        <div class="form-group vhi-group">
                            <label>3. 大家會問我「你的聲音怎麼了」:</label>
                            <select name="vhi3">{% for i in range(5) %}<option value="{{ i }}">{{ i }}</option>{% endfor %}</select>
                        </div>
                    </div>
                    <div class="form-group-pair">
                        <div class="form-group vhi-group">
                            <label>4. 我的聲音聽起來沙啞、乾澀:</label>
                            <select name="vhi4">{% for i in range(5) %}<option value="{{ i }}">{{ i }}</option>{% endfor %}</select>
                        </div>
                    </div>
                    <div class="form-group-pair">
                        <div class="form-group vhi-group">
                            <label>5. 我覺得我必須要用力才能發出聲音:</label>
                            <select name="vhi5">{% for i in range(5) %}<option value="{{ i }}">{{ i }}</option>{% endfor %}</select>
                        </div>
                    </div>
                    <div class="form-group-pair">
                        <div class="form-group vhi-group">
                            <label>6. 我聲音的清晰度是無法預測、變化多端的:</label>
                            <select name="vhi6">{% for i in range(5) %}<option value="{{ i }}">{{ i }}</option>{% endfor %}</select>
                        </div>
                    </div>
                    <div class="form-group-pair">
                        <div class="form-group vhi-group">
                            <label>7. 我試著改變我的聲音使它聽起來不同:</label>
                            <select name="vhi7">{% for i in range(5) %}<option value="{{ i }}">{{ i }}</option>{% endfor %}</select>
                        </div>
                    </div>
                    <div class="form-group-pair">
                        <div class="form-group vhi-group">
                            <label>8. 說話使我感到吃力:</label>
                            <select name="vhi8">{% for i in range(5) %}<option value="{{ i }}">{{ i }}</option>{% endfor %}</select>
                        </div>
                    </div>
                    <div class="form-group-pair">
                        <div class="form-group vhi-group">
                            <label>9. 傍晚過後我的聲音聽起來更糟:</label>
                            <select name="vhi9">{% for i in range(5) %}<option value="{{ i }}">{{ i }}</option>{% endfor %}</select>
                        </div>
                    </div>
                    <div class="form-group-pair">
                        <div class="form-group vhi-group">
                            <label>10. 說話說到一半時、聲音會失控失聲:</label>
                            <select name="vhi10">{% for i in range(5) %}<option value="{{ i }}">{{ i }}</option>{% endfor %}</select>
                        </div>
                    </div>

                <div class="nav-row">
                    <button type="button" class="nav-btn btn-prev" onclick="prevStep()">上一步</button>
                </div>
                <button type="submit" class="btn-submit">送出病歷</button>
            </div>
        </form>
    </div>

<script>
function updatePPD() {
    const smoking = document.getElementById("smoking");
    const ppd = document.getElementById("ppd");
    if (!smoking || !ppd) return;
    if (smoking.value === "0") {
        ppd.value = 0;
        ppd.readOnly = true;
    } else {
        ppd.readOnly = false;
    }
}
document.getElementById("smoking").addEventListener("change", updatePPD);

// Wizard
let currentStep = 1;
const totalSteps = 3;

function showStep(n) {
    for (let i = 1; i <= totalSteps; i++) {
        const stepEl = document.getElementById(`step-${i}`);
        const dotEl = document.getElementById(`dot-${i}`);
        if (stepEl) stepEl.classList.toggle('active', i === n);
        if (dotEl) dotEl.classList.toggle('active', i === n);
    }
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function validateStep(n) {
    const stepEl = document.getElementById(`step-${n}`);
    if (!stepEl) return true;
    const fields = stepEl.querySelectorAll('input, select, textarea');
    for (const el of fields) {
        if (el.hasAttribute('required')) {
            if (!el.reportValidity()) {
                return false;
            }
        }
    }
    // 額外檢查：抽菸=從未時，自動矯正 ppd
    if (n === 2) updatePPD();
    return true;
}

function nextStep() {
    if (!validateStep(currentStep)) return;
    if (currentStep < totalSteps) {
        currentStep += 1;
        showStep(currentStep);
    }
}

function prevStep() {
    if (currentStep > 1) {
        currentStep -= 1;
        showStep(currentStep);
    }
}

// 初始化
window.addEventListener("load", () => {
    updatePPD();
    showStep(1);
});
</script>
</body>
</html>